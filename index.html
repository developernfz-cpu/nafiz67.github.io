<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ULTRA CITY HOPE - GTA Web</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #111;
            color: white;
            touch-action: none;
        }

        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* LOADING SCREEN */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 5px solid #333;
            border-top: 5px solid #00a8ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        #loadingText {
            font-size: 24px;
            margin-top: 20px;
            color: #00a8ff;
        }

        /* HUD */
        #hud {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .hud-top {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
        }

        .hud-bottom {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
        }

        .hud-stat {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 10px 15px;
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .stat-bar {
            width: 200px;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s;
        }

        #healthBar { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        #staminaBar { background: linear-gradient(90deg, #f39c12, #e67e22); }
        #money { color: #f1c40f; font-weight: bold; }
        #weaponDisplay { background: rgba(0, 0, 0, 0.7); padding: 8px 12px; border-radius: 20px; }

        /* MOBILE CONTROLS */
        #mobileControls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 20;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }

        .joystick {
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .joystick-handle {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid rgba(0, 0, 0, 0.3);
        }

        .action-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }

        .action-button:active {
            transform: scale(0.9);
            background: rgba(0, 0, 0, 0.9);
        }

        #jumpBtn { background: rgba(41, 128, 185, 0.8); }
        #attackBtn { background: rgba(231, 76, 60, 0.8); }
        #interactBtn { background: rgba(46, 204, 113, 0.8); }
        #menuBtn { background: rgba(149, 165, 166, 0.8); }

        /* MENUS */
        .menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 30;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .menu-content {
            background: rgba(30, 30, 40, 0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border: 2px solid #00a8ff;
            box-shadow: 0 0 50px rgba(0, 168, 255, 0.3);
        }

        .menu h2 {
            color: #00a8ff;
            margin-bottom: 20px;
            text-align: center;
            font-size: 32px;
        }

        .menu-button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 168, 255, 0.2);
            border: 2px solid #00a8ff;
            color: white;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-button:hover {
            background: rgba(0, 168, 255, 0.4);
            transform: translateY(-2px);
        }

        .menu-button:active {
            transform: translateY(0);
        }

        /* MISSION NOTIFICATION */
        #missionNotification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            border-left: 5px solid #00a8ff;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 40;
            display: none;
            backdrop-filter: blur(10px);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* CROSSHAIR */
        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 5;
        }

        .crosshair-dot {
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .crosshair-line {
            position: absolute;
            background: #fff;
        }

        .crosshair-horizontal {
            width: 10px;
            height: 2px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .crosshair-vertical {
            width: 2px;
            height: 10px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .joystick {
                width: 100px;
                height: 100px;
            }
            
            .action-button {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }
            
            .hud-stat {
                padding: 8px 12px;
                font-size: 14px;
            }
        }

        /* FPS COUNTER */
        #fpsCounter {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
        }

        /* HIT MARKER */
        #hitMarker {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 25;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .hit-line {
            position: absolute;
            background: #ff0000;
        }

        .hit-line-1 { top: 0; left: 50%; width: 2px; height: 10px; transform: translateX(-50%); }
        .hit-line-2 { bottom: 0; left: 50%; width: 2px; height: 10px; transform: translateX(-50%); }
        .hit-line-3 { left: 0; top: 50%; width: 10px; height: 2px; transform: translateY(-50%); }
        .hit-line-4 { right: 0; top: 50%; width: 10px; height: 2px; transform: translateY(-50%); }
    </style>
</head>
<body>
    <!-- LOADING SCREEN -->
    <div id="loadingScreen">
        <div class="loader"></div>
        <h2>ULTRA CITY HOPE</h2>
        <p id="loadingText">Loading Game Assets...</p>
        <p style="margin-top: 20px; color: #666;">Optimized for Mobile & Chromebook</p>
    </div>

    <!-- CANVAS -->
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div id="hud">
        <!-- Crosshair -->
        <div id="crosshair">
            <div class="crosshair-dot"></div>
            <div class="crosshair-line crosshair-horizontal"></div>
            <div class="crosshair-line crosshair-vertical"></div>
        </div>

        <!-- Hit Marker -->
        <div id="hitMarker">
            <div class="hit-line hit-line-1"></div>
            <div class="hit-line hit-line-2"></div>
            <div class="hit-line hit-line-3"></div>
            <div class="hit-line hit-line-4"></div>
        </div>

        <!-- Top HUD -->
        <div class="hud-top">
            <div class="hud-stat">
                <div><i class="fas fa-heart" style="color: #e74c3c;"></i> HEALTH</div>
                <div class="stat-bar">
                    <div id="healthBar" class="stat-fill" style="width: 100%"></div>
                </div>
            </div>
            
            <div class="hud-stat">
                <div><i class="fas fa-bolt" style="color: #f39c12;"></i> STAMINA</div>
                <div class="stat-bar">
                    <div id="staminaBar" class="stat-fill" style="width: 100%"></div>
                </div>
            </div>
            
            <div class="hud-stat">
                <div><i class="fas fa-money-bill-wave"></i> CASH</div>
                <div id="money">$1000</div>
            </div>
            
            <div id="weaponDisplay">
                <i class="fas fa-fist-raised"></i> FIST
            </div>
        </div>

        <!-- Bottom HUD -->
        <div class="hud-bottom">
            <div id="missionNotification">
                <strong>MISSION:</strong> Explore the city!
            </div>
        </div>
    </div>

    <!-- MOBILE CONTROLS -->
    <div id="mobileControls">
        <div class="control-group">
            <div class="joystick" id="moveJoystick">
                <div class="joystick-handle"></div>
            </div>
            <div class="action-button" id="jumpBtn">
                <i class="fas fa-arrow-up"></i>
            </div>
        </div>
        
        <div class="control-group">
            <div class="action-button" id="attackBtn">
                <i class="fas fa-crosshairs"></i>
            </div>
            <div class="action-button" id="interactBtn">
                <i class="fas fa-car"></i>
            </div>
            <div class="action-button" id="menuBtn">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </div>

    <!-- MAIN MENU -->
    <div id="mainMenu" class="menu">
        <div class="menu-content">
            <h2>ULTRA CITY HOPE</h2>
            <button class="menu-button" id="resumeBtn">
                <i class="fas fa-play"></i> RESUME GAME
            </button>
            <button class="menu-button" id="newGameBtn">
                <i class="fas fa-plus-circle"></i> NEW GAME
            </button>
            <button class="menu-button" id="settingsBtn">
                <i class="fas fa-cog"></i> SETTINGS
            </button>
            <button class="menu-button" id="helpBtn">
                <i class="fas fa-question-circle"></i> HELP & CONTROLS
            </button>
        </div>
    </div>

    <!-- SETTINGS MENU -->
    <div id="settingsMenu" class="menu">
        <div class="menu-content">
            <h2><i class="fas fa-cog"></i> SETTINGS</h2>
            <button class="menu-button" id="backBtn">
                <i class="fas fa-arrow-left"></i> BACK
            </button>
            <div style="margin: 20px 0; color: #00a8ff;">
                <div style="margin: 10px 0;">
                    <label>Graphics Quality:</label>
                    <select id="graphicsQuality" style="width: 100%; padding: 10px; margin-top: 5px; background: #222; color: white; border: 1px solid #00a8ff; border-radius: 5px;">
                        <option value="low">Low (Mobile)</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div style="margin: 10px 0;">
                    <label>Controls:</label>
                    <select id="controlType" style="width: 100%; padding: 10px; margin-top: 5px; background: #222; color: white; border: 1px solid #00a8ff; border-radius: 5px;">
                        <option value="touch">Touch Controls</option>
                        <option value="keyboard">Keyboard</option>
                    </select>
                </div>
            </div>
            <button class="menu-button" onclick="saveSettings()">
                <i class="fas fa-save"></i> SAVE SETTINGS
            </button>
        </div>
    </div>

    <!-- HELP MENU -->
    <div id="helpMenu" class="menu">
        <div class="menu-content">
            <h2><i class="fas fa-question-circle"></i> CONTROLS</h2>
            <div style="margin: 20px 0; line-height: 1.6;">
                <p><strong>MOBILE:</strong></p>
                <p><i class="fas fa-arrows-alt"></i> Left Joystick - Move</p>
                <p><i class="fas fa-arrow-up"></i> Jump Button - Jump</p>
                <p><i class="fas fa-crosshairs"></i> Red Button - Attack/Shoot</p>
                <p><i class="fas fa-car"></i> Green Button - Enter Vehicle</p>
                <p><i class="fas fa-bars"></i> Menu Button - Pause Game</p>
                
                <p style="margin-top: 20px;"><strong>KEYBOARD:</strong></p>
                <p>WASD - Move</p>
                <p>Space - Jump</p>
                <p>F - Attack/Shoot</p>
                <p>E - Enter Vehicle</p>
                <p>ESC - Pause Menu</p>
                <p>1-3 - Switch Weapons</p>
            </div>
            <button class="menu-button" id="helpBackBtn">
                <i class="fas fa-arrow-left"></i> BACK
            </button>
        </div>
    </div>

    <!-- FPS COUNTER -->
    <div id="fpsCounter">FPS: 0</div>

    <script>
        // GAME STATE
        const gameState = {
            isLoaded: false,
            isPaused: false,
            player: {
                health: 100,
                stamina: 100,
                money: 1000,
                position: { x: 0, y: 10, z: 0 },
                rotation: 0,
                velocity: { x: 0, y: 0, z: 0 },
                isJumping: false,
                currentWeapon: 0,
                weapons: ['Fist', 'Pistol', 'SMG'],
                inVehicle: false
            },
            settings: {
                graphics: 'medium',
                controls: 'touch'
            },
            world: {
                time: 12,
                weather: 'sunny'
            },
            missions: [
                { id: 1, title: 'Explore the City', completed: false },
                { id: 2, title: 'Collect $500', completed: false }
            ]
        };

        // CANVAS SETUP
        const canvas = document.getElementById('gameCanvas');
        const gl = canvas.getContext('webgl2') || canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        if (!gl) {
            alert('WebGL not supported! Try Chrome or Firefox.');
            throw new Error('WebGL not supported');
        }

        // RESIZE HANDLER
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gl.viewport(0, 0, canvas.width, canvas.height);
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // SIMPLE 3D RENDERER (Optimized for Mobile)
        class Simple3D {
            constructor() {
                this.objects = [];
                this.camera = {
                    x: 0, y: 15, z: 30,
                    rx: -0.3, ry: 0
                };
                
                // Create basic 3D objects
                this.createCity();
                this.createPlayer();
            }
            
            createCity() {
                // Ground
                this.objects.push({
                    type: 'plane',
                    position: { x: 0, y: 0, z: 0 },
                    size: { width: 1000, height: 1000 },
                    color: [0.2, 0.6, 0.2]
                });
                
                // Buildings
                for (let i = 0; i < 20; i++) {
                    const size = 20 + Math.random() * 30;
                    this.objects.push({
                        type: 'cube',
                        position: { 
                            x: (Math.random() - 0.5) * 800, 
                            y: size/2, 
                            z: (Math.random() - 0.5) * 800 
                        },
                        size: { width: 15, height: size, depth: 15 },
                        color: [
                            0.3 + Math.random() * 0.3,
                            0.3 + Math.random() * 0.3,
                            0.4 + Math.random() * 0.3
                        ]
                    });
                }
                
                // Roads
                for (let i = -5; i <= 5; i++) {
                    this.objects.push({
                        type: 'plane',
                        position: { x: i * 80, y: 0.1, z: 0 },
                        size: { width: 20, height: 1000 },
                        color: [0.3, 0.3, 0.3]
                    });
                    this.objects.push({
                        type: 'plane',
                        position: { x: 0, y: 0.1, z: i * 80 },
                        size: { width: 1000, height: 20 },
                        color: [0.3, 0.3, 0.3]
                    });
                }
                
                // Trees
                for (let i = 0; i < 50; i++) {
                    this.objects.push({
                        type: 'cylinder',
                        position: { 
                            x: (Math.random() - 0.5) * 900, 
                            y: 5, 
                            z: (Math.random() - 0.5) * 900 
                        },
                        size: { radius: 2, height: 10 },
                        color: [0.4, 0.2, 0.1]
                    });
                    this.objects.push({
                        type: 'cone',
                        position: { 
                            x: (Math.random() - 0.5) * 900, 
                            y: 15, 
                            z: (Math.random() - 0.5) * 900 
                        },
                        size: { radius: 5, height: 10 },
                        color: [0.1, 0.5, 0.1]
                    });
                }
            }
            
            createPlayer() {
                this.player = {
                    type: 'cube',
                    position: { x: 0, y: 10, z: 0 },
                    size: { width: 5, height: 10, depth: 5 },
                    color: [0.8, 0.1, 0.1]
                };
            }
            
            update(deltaTime) {
                // Update camera based on player
                const targetX = gameState.player.position.x;
                const targetZ = gameState.player.position.z + 30;
                const targetY = gameState.player.position.y + 15;
                
                // Smooth camera follow
                this.camera.x += (targetX - this.camera.x) * 0.1;
                this.camera.y += (targetY - this.camera.y) * 0.1;
                this.camera.z += (targetZ - this.camera.z) * 0.1;
                
                // Update player position
                this.player.position.x = gameState.player.position.x;
                this.player.position.y = gameState.player.position.y;
                this.player.position.z = gameState.player.position.z;
            }
            
            render() {
                // Clear screen
                gl.clearColor(0.53, 0.81, 0.98, 1.0); // Sky blue
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.enable(gl.DEPTH_TEST);
                
                // Simple orthographic projection for now
                const aspect = canvas.width / canvas.height;
                const scale = 100;
                
                // Draw each object
                [...this.objects, this.player].forEach(obj => {
                    if (!obj) return;
                    
                    // Set color
                    gl.clearColor(obj.color[0], obj.color[1], obj.color[2], 1.0);
                    
                    // Draw based on type
                    switch(obj.type) {
                        case 'cube':
                            this.drawCube(obj.position, obj.size);
                            break;
                        case 'plane':
                            this.drawPlane(obj.position, obj.size);
                            break;
                        case 'cylinder':
                            this.drawCylinder(obj.position, obj.size);
                            break;
                        case 'cone':
                            this.drawCone(obj.position, obj.size);
                            break;
                    }
                });
            }
            
            drawCube(pos, size) {
                // Simple wireframe cube drawing
                const vertices = [
                    // Front face
                    pos.x - size.width/2, pos.y - size.height/2, pos.z + size.depth/2,
                    pos.x + size.width/2, pos.y - size.height/2, pos.z + size.depth/2,
                    pos.x + size.width/2, pos.y + size.height/2, pos.z + size.depth/2,
                    pos.x - size.width/2, pos.y + size.height/2, pos.z + size.depth/2,
                    
                    // Back face
                    pos.x - size.width/2, pos.y - size.height/2, pos.z - size.depth/2,
                    pos.x + size.width/2, pos.y - size.height/2, pos.z - size.depth/2,
                    pos.x + size.width/2, pos.y + size.height/2, pos.z - size.depth/2,
                    pos.x - size.width/2, pos.y + size.height/2, pos.z - size.depth/2
                ];
                
                const indices = [
                    // Front
                    0, 1, 1, 2, 2, 3, 3, 0,
                    // Back
                    4, 5, 5, 6, 6, 7, 7, 4,
                    // Connections
                    0, 4, 1, 5, 2, 6, 3, 7
                ];
                
                this.drawLines(vertices, indices);
            }
            
            drawPlane(pos, size) {
                const vertices = [
                    pos.x - size.width/2, pos.y, pos.z - size.height/2,
                    pos.x + size.width/2, pos.y, pos.z - size.height/2,
                    pos.x + size.width/2, pos.y, pos.z + size.height/2,
                    pos.x - size.width/2, pos.y, pos.z + size.height/2
                ];
                
                const indices = [0, 1, 1, 2, 2, 3, 3, 0];
                this.drawLines(vertices, indices);
            }
            
            drawLines(vertices, indices) {
                // Simple line drawing implementation
                // In a real game, you'd use proper shaders and buffers
                // This is a simplified version for demonstration
                
                gl.lineWidth(2);
                // ... actual WebGL drawing code would go here
            }
            
            // Placeholder methods for other shapes
            drawCylinder(pos, size) {}
            drawCone(pos, size) {}
        }

        // INPUT MANAGER
        class InputManager {
            constructor() {
                this.keys = {};
                this.touch = {
                    moveX: 0,
                    moveY: 0,
                    isTouching: false
                };
                
                this.setupEventListeners();
                this.setupJoystick();
            }
            
            setupEventListeners() {
                // Keyboard
                document.addEventListener('keydown', (e) => {
                    if (gameState.settings.controls === 'keyboard') {
                        this.keys[e.key.toLowerCase()] = true;
                        
                        if (e.key === 'Escape') {
                            toggleMenu();
                        }
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    if (gameState.settings.controls === 'keyboard') {
                        this.keys[e.key.toLowerCase()] = false;
                    }
                });
                
                // Prevent context menu on mobile
                document.addEventListener('contextmenu', (e) => e.preventDefault());
            }
            
            setupJoystick() {
                const joystick = document.getElementById('moveJoystick');
                const handle = joystick.querySelector('.joystick-handle');
                
                let isDragging = false;
                
                joystick.addEventListener('touchstart', (e) => {
                    if (gameState.settings.controls === 'touch') {
                        isDragging = true;
                        e.preventDefault();
                    }
                });
                
                joystick.addEventListener('touchmove', (e) => {
                    if (gameState.settings.controls === 'touch' && isDragging) {
                        const rect = joystick.getBoundingClientRect();
                        const touch = e.touches[0];
                        const x = touch.clientX - rect.left - rect.width / 2;
                        const y = touch.clientY - rect.top - rect.height / 2;
                        
                        const distance = Math.min(Math.sqrt(x*x + y*y), rect.width / 2);
                        const angle = Math.atan2(y, x);
                        
                        this.touch.moveX = Math.cos(angle) * (distance / (rect.width / 2));
                        this.touch.moveY = Math.sin(angle) * (distance / (rect.height / 2));
                        
                        handle.style.transform = `translate(-50%, -50%) translate(${this.touch.moveX * 30}px, ${this.touch.moveY * 30}px)`;
                        e.preventDefault();
                    }
                });
                
                joystick.addEventListener('touchend', () => {
                    if (gameState.settings.controls === 'touch') {
                        isDragging = false;
                        this.touch.moveX = 0;
                        this.touch.moveY = 0;
                        handle.style.transform = 'translate(-50%, -50%)';
                    }
                });
            }
            
            getMovement() {
                if (gameState.settings.controls === 'keyboard') {
                    return {
                        x: (this.keys['a'] ? -1 : 0) + (this.keys['d'] ? 1 : 0),
                        y: (this.keys['w'] ? -1 : 0) + (this.keys['s'] ? 1 : 0)
                    };
                } else {
                    return {
                        x: this.touch.moveX,
                        y: this.touch.moveY
                    };
                }
            }
            
            isKeyPressed(key) {
                return this.keys[key] || false;
            }
        }

        // GAME LOGIC
        class GameLogic {
            constructor() {
                this.input = new InputManager();
                this.renderer = new Simple3D();
                this.lastTime = 0;
                this.fps = 0;
                this.frameCount = 0;
                this.lastFpsUpdate = 0;
                
                // Game objects
                this.vehicles = [];
                this.collectibles = [];
                this.npcs = [];
                
                this.initGameObjects();
            }
            
            initGameObjects() {
                // Create some vehicles
                for (let i = 0; i < 10; i++) {
                    this.vehicles.push({
                        x: (Math.random() - 0.5) * 200,
                        z: (Math.random() - 0.5) * 200,
                        type: 'car',
                        color: `hsl(${Math.random() * 360}, 100%, 50%)`
                    });
                }
                
                // Create collectibles
                for (let i = 0; i < 20; i++) {
                    this.collectibles.push({
                        x: (Math.random() - 0.5) * 400,
                        z: (Math.random() - 0.5) * 400,
                        collected: false
                    });
                }
            }
            
            updatePlayer(deltaTime) {
                const move = this.input.getMovement();
                const speed = 10 * deltaTime;
                
                // Apply movement
                gameState.player.position.x += move.x * speed;
                gameState.player.position.z += move.y * speed;
                
                // Gravity and jumping
                if (!gameState.player.isJumping) {
                    gameState.player.position.y = Math.max(10, gameState.player.position.y - 5 * deltaTime);
                }
                
                // Check for jump
                if (this.input.isKeyPressed(' ') || document.getElementById('jumpBtn').classList.contains('active')) {
                    if (!gameState.player.isJumping) {
                        gameState.player.isJumping = true;
                        gameState.player.velocity.y = 15;
                    }
                }
                
                if (gameState.player.isJumping) {
                    gameState.player.position.y += gameState.player.velocity.y * deltaTime;
                    gameState.player.velocity.y -= 30 * deltaTime;
                    
                    if (gameState.player.position.y <= 10) {
                        gameState.player.position.y = 10;
                        gameState.player.isJumping = false;
                        gameState.player.velocity.y = 0;
                    }
                }
                
                // Stamina drain
                if (Math.abs(move.x) > 0.1 || Math.abs(move.y) > 0.1) {
                    gameState.player.stamina = Math.max(0, gameState.player.stamina - 5 * deltaTime);
                } else {
                    gameState.player.stamina = Math.min(100, gameState.player.stamina + 10 * deltaTime);
                }
                
                // Check collectibles
                this.collectibles.forEach(item => {
                    if (!item.collected) {
                        const dx = item.x - gameState.player.position.x;
                        const dz = item.z - gameState.player.position.z;
                        const distance = Math.sqrt(dx*dx + dz*dz);
                        
                        if (distance < 10) {
                            item.collected = true;
                            gameState.player.money += 50;
                            showNotification('+$50 Collected!');
                        }
                    }
                });
                
                // Update UI
                updateHUD();
            }
            
            update(time) {
                if (!gameState.isLoaded || gameState.isPaused) return;
                
                const deltaTime = Math.min(0.1, (time - this.lastTime) / 1000);
                this.lastTime = time;
                
                // Update FPS counter
                this.frameCount++;
                if (time - this.lastFpsUpdate > 1000) {
                    this.fps = Math.round((this.frameCount * 1000) / (time - this.lastFpsUpdate));
                    this.frameCount = 0;
                    this.lastFpsUpdate = time;
                    document.getElementById('fpsCounter').textContent = `FPS: ${this.fps}`;
                }
                
                // Update game logic
                this.updatePlayer(deltaTime);
                this.renderer.update(deltaTime);
                this.renderer.render();
                
                // Continue game loop
                requestAnimationFrame((t) => this.update(t));
            }
            
            start() {
                this.lastTime = performance.now();
                requestAnimationFrame((t) => this.update(t));
            }
        }

        // UI FUNCTIONS
        function updateHUD() {
            document.getElementById('healthBar').style.width = `${gameState.player.health}%`;
            document.getElementById('staminaBar').style.width = `${gameState.player.stamina}%`;
            document.getElementById('money').textContent = `$${gameState.player.money}`;
            document.getElementById('weaponDisplay').innerHTML = 
                `<i class="fas fa-${getWeaponIcon()}"></i> ${gameState.player.weapons[gameState.player.currentWeapon]}`;
        }
        
        function getWeaponIcon() {
            switch(gameState.player.currentWeapon) {
                case 0: return 'fist-raised';
                case 1: return 'gun';
                case 2: return 'crosshairs';
                default: return 'fist-raised';
            }
        }
        
        function showNotification(text) {
            const notification = document.getElementById('missionNotification');
            notification.innerHTML = `<strong>${text}</strong>`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function toggleMenu() {
            gameState.isPaused = !gameState.isPaused;
            document.getElementById('mainMenu').style.display = gameState.isPaused ? 'flex' : 'none';
        }
        
        function saveSettings() {
            gameState.settings.graphics = document.getElementById('graphicsQuality').value;
            gameState.settings.controls = document.getElementById('controlType').value;
            
            // Show mobile controls based on setting
            document.getElementById('mobileControls').style.display = 
                gameState.settings.controls === 'touch' ? 'flex' : 'none';
            
            document.getElementById('settingsMenu').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            
            showNotification('Settings Saved!');
        }

        // INITIALIZATION
        async function initGame() {
            console.log('Starting Ultra City Hope...');
            
            // Show loading progress
            const loadingText = document.getElementById('loadingText');
            const loadingStages = [
                'Loading 3D Engine...',
                'Creating World...',
                'Loading Assets...',
                'Initializing Physics...',
                'Ready!'
            ];
            
            for (let i = 0; i < loadingStages.length; i++) {
                loadingText.textContent = loadingStages[i];
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // Initialize game
            const game = new GameLogic();
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    gameState.isLoaded = true;
                    game.start();
                    
                    // Show welcome message
                    setTimeout(() => {
                        showNotification('Welcome to ULTRA CITY HOPE!');
                    }, 1000);
                }, 500);
            }, 1000);
            
            // Setup button listeners
            setupButtonListeners();
        }
        
        function setupButtonListeners() {
            // Menu buttons
            document.getElementById('resumeBtn').onclick = () => {
                toggleMenu();
            };
            
            document.getElementById('newGameBtn').onclick = () => {
                if (confirm('Start new game? Current progress will be lost.')) {
                    location.reload();
                }
            };
            
            document.getElementById('settingsBtn').onclick = () => {
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('settingsMenu').style.display = 'flex';
            };
            
            document.getElementById('helpBtn').onclick = () => {
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('helpMenu').style.display = 'flex';
            };
            
            document.getElementById('backBtn').onclick = () => {
                document.getElementById('settingsMenu').style.display = 'none';
                document.getElementById('mainMenu').style.display = 'flex';
            };
            
            document.getElementById('helpBackBtn').onclick = () => {
                document.getElementById('helpMenu').style.display = 'none';
                document.getElementById('mainMenu').style.display = 'flex';
            };
            
            // Action buttons
            const attackBtn = document.getElementById('attackBtn');
            attackBtn.addEventListener('touchstart', () => {
                attackBtn.classList.add('active');
                showHitMarker();
            });
            attackBtn.addEventListener('touchend', () => {
                attackBtn.classList.remove('active');
            });
            
            document.getElementById('interactBtn').onclick = () => {
                showNotification('Looking for vehicle...');
            };
            
            document.getElementById('menuBtn').onclick = toggleMenu;
            
            // Jump button
            const jumpBtn = document.getElementById('jumpBtn');
            jumpBtn.addEventListener('touchstart', () => {
                jumpBtn.classList.add('active');
            });
            jumpBtn.addEventListener('touchend', () => {
                jumpBtn.classList.remove('active');
            });
        }
        
        function showHitMarker() {
            const hitMarker = document.getElementById('hitMarker');
            hitMarker.style.opacity = '1';
            
            setTimeout(() => {
                hitMarker.style.opacity = '0';
            }, 100);
        }

        // START GAME WHEN READY
        document.addEventListener('DOMContentLoaded', initGame);
        
        // Prevent zoom on mobile
        document.addEventListener('touchmove', (e) => {
            if (e.scale !== 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Prevent pull-to-refresh
        document.body.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Make game fullscreen on mobile
        document.documentElement.requestFullscreen?.().catch(console.log);
    </script>
</body>
</html>
